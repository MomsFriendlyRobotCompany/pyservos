##############################################
# The MIT License (MIT)
# Copyright (c) 2016 Kevin Walchko
# see LICENSE for full details
##############################################
# Tests for continous integration

from __future__ import print_function, division
from pyservos import Packet
from pyservos.packet import angle2int, le
from pyservos import AX12
from pyservos import ServoSerial
from nose.tools import raises
from math import pi


def test_ax12_find_packets():
	ax = AX12()

	# 2 good packets
	data = [
		0x3, 0x4,  # noise
		0xff, 0xff, 0x01, 0x04, 0x02, 0x2b, 0x01, 0xcc,
		0xff, 0xff,  # random header
		0xff, 0xff, 0xfe, 0x18, 0x83, 0x1e, 0x04, 0x00, 0x10, 0x00, 0x50, 0x01, 0x01, 0x20, 0x02, 0x60, 0x03, 0x02, 0x30, 0x00, 0x70, 0x01, 0x03, 0x20, 0x02, 0x80, 0x03, 0x12  # sync write
	]

	ans = ax.find_packets(data)

	assert len(ans) == 2
	for a in ans:
		assert a


@raises(Exception)
def test_ax12_fail_find_packets():
	ax = AX12()

	data = [
		0xff, 0xff,   # random header
		0xff, 0xff, 0x01, 0x04, 0x02, 0x2b, 0x01, 0x11  # bad packet, crc is wrong
	]

	ans = ax.find_packets(data)

	assert len(ans) == 1
	for a in ans:
		assert a


def test_fake_serial():
	s = ServoSerial('/dev/null')
	s.open()
	msg = [71, 72, 73]
	s.write(msg)
	ret = s.read()
	for r, m in zip(ret, msg):
		assert r == m

	s.write(msg)
	s.flushInput()  # destroy input, ret should be empty now
	ret = s.read()
	assert len(ret) == 0

	s.close()


def test_ax12_check_sum():
	# data packets from:
	# http://support.robotis.com/en/product/actuator/dynamixel/communication/dxl_instruction.htm
	data = [
		[0xff, 0xff, 0x01, 0x04, 0x02, 0x2b, 0x01, 0xcc],  # read data
		[0xff, 0xff, 0xfe, 0x04, 0x03, 0x03, 0x1, 0xf6],  # write data
		[0xFF, 0xFF, 0x01, 0x02, 0x24, 0xD8],  # overload and over heat error
		[0xff, 0xff, 0x01, 0x02, 0x01, 0xfb],  # reg write
		[0xff, 0xff, 0x00, 0x02, 0x06, 0xf7],  # reset
		[0xff, 0xff, 0x01, 0x04, 0x02, 0x00, 0x03, 0xf5],  # read firmware
		[0xff, 0xff, 0x01, 0x02, 0x00, 0xfc],  # led status packet, no error
		[0xff, 0xff, 0xfe, 0x18, 0x83, 0x1e, 0x04, 0x00, 0x10, 0x00, 0x50, 0x01, 0x01, 0x20, 0x02, 0x60, 0x03, 0x02, 0x30, 0x00, 0x70, 0x01, 0x03, 0x20, 0x02, 0x80, 0x03, 0x12]  # sync write
	]
	for d in data:
		cs = AX12.check_sum(d[2:-1])
		assert cs == d[-1]


def test_ax12_sync_write():
	ax = Packet(AX12)

	path = [
		# ID position velocity
		[0, 0x10, 0x00, 0x50, 0x01],
		[1, 0x20, 0x02, 0x60, 0x03],
		[2, 0x30, 0x00, 0x70, 0x01],
		[3, 0x20, 0x02, 0x80, 0x03]
	]
	ans = [0xff, 0xff, 0xfe, 0x18, 0x83, 0x1e, 0x4, 0x0, 0x10, 0x0, 0x50, 0x1, 0x1, 0x20, 0x2, 0x60, 0x3, 0x2, 0x30, 0x0, 0x70, 0x1, 0x3, 0x20, 0x2, 0x80, 0x3, 0x12]
	pkt = ax.makeSyncWritePacket(AX12.GOAL_POSITION, path)
	for p, a in zip(pkt, ans):
		assert p == a


def test_angle2int():
	for angle in [0, 90, 180, 270, 300]:
		a = int(angle/300.0*1023.0)
		assert angle2int(angle, True) == le(a)

	for angle in [0, pi/4, pi/2, 3*pi/2]:
		a = int(180*angle/300.0/pi*1023.0)
		assert angle2int(angle, False) == le(a)


@raises(Exception)
def test_ax12_led_fail():
	ax = Packet(AX12)
	ax.makeLEDPacket(2, 5)
